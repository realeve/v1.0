var PaperParam=function(){function t(){$('form input[type="text"]').eq(0).focus()}function e(){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=24&M=3&t=1&cache=14400";$.ajax({url:t}).done(function(t){var e=handleAjaxData(t);InitSelect("Prod_id",e)}),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=0&cache=14400",$.ajax({url:t}).done(function(t){var e=handleAjaxData(t);InitSelect("machine_id",e)}),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=25&M=3&t=1&cache=14400",$.ajax({url:t}).done(function(t){t=handleAjaxData(t),InitSelect("oper_id",t)}),initSelect2()}function a(){e(),$("input[name='rec_date']").val(today(6)),$("input[name='Reel_Code']").maxlength({limitReachedClass:"label label-danger",threshold:3}),$(".page-header .dropdown-quick-sidebar-toggler").hide(),h=getUrlParam("sreel"),h=null==h?0:h,t(),c="",u=""}function r(){var t=(new Date).getHours();t>=0&&t<8?SetiCheckChecked("class_id",2):t>=8&&t<16?SetiCheckChecked("class_id",0):SetiCheckChecked("class_id",1)}function n(){return""===$('select[name="oper_id"]').val()||""===$('select[name="prod_ID"]').val()||""===$('select[name="machine_ID"]').val()?($(".portlet.light").hide(),1):($(".portlet.light").show(),0)}function o(t,e){var a=t[e];Object.keys(a).map(function(t){console.log(t);var e=a[t],r=void 0===e.max?"≥"+e.min:void 0===e.min?"≤"+e.max:e.min+" — "+e.max;$('input[name="'+t+'"]').parent().find("span").text(r)})}function i(){var t=$('select[name="Prod_id"]').val()+$('input[name="Reel_Code"]').val(),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=33&M=0&r="+t,a=ReadData(e);return"0"==a.rows?0:($('input[name="Reel_Code"]').data("reelcode",t),a.header.map(function(t){var e=t.title;$('form .form-control[name="'+e+'"]').val(a.data[0][e])}),SetSelect2Val("oper_id",a.data[0].oper_id),SetSelect2Val("Prod_id",a.data[0].Prod_id),SetSelect2Val("machine_id",a.data[0].machine_id),SetiCheckChecked("class_id",a.data[0].class_id),$('.portlet button[type="submit"]').data("sn",a.data[0].ID),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("提交","更新")),$(".portlet.light").show(),s(),$(".amounts h4").html("<strong>评价总分:</strong> "+a.data[0].score),$("#checkbox2").iCheck("uncheck"),$(".normalPara input").attr("disabled","true"),$(".normalParaEdit").show(),1)}function s(){var t=$("input[name='rec_date']").val();t=t.substr(0,4)+t.substr(5,2);var e=$('select[name="Prod_id"]').val(),a=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=27&M=3&tmonth="+t+"&prod="+e,r=ReadData(a);a=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=28&M=3&tmonth="+t+"&prod="+e;var n=ReadData(a);$(".grey-cascade").html("物理指标："+xround(r.data[0][0],2)+"，外观指标："+xround(n.data[0][0],2)+"，总分："+xround(parseFloat(r.data[0][0])+parseFloat(n.data[0][0])-100,2))}function d(t,e,a){void 0===a&&(a=!0);var r,n=1,o=GetSelect2Text("Prod_id");if(void 0!==(r="103-G-7T"===o?g["9607T"]:"103-G-2A"===o?g["9602A"]:"103-G-6T"===o?g["9606T"]:g.normal)[t]){var i=$(".validateData input[name="+t+"]:enabled").parents(".form-group").find("label").text();e<r[t].w_min||e>r[t].w_max?(n=0,a&&(bsTips("【"+i+"】的值"+e+"不在指定范围内,产品判定为不合格，请仔细确认检查",0),-1==c.indexOf(i)&&(c+=i+"、"))):c=c.replace(i+"、","")}return n}function l(){var t=getRootPath(1)+"/assets/pages/controller/data/paper_physic.json";$.get(t,function(t){g=t})}function m(t){var e,a,r,n=100,o=1;void 0===t&&(t=0);var i=GetSelect2Text("Prod_id");return r="103-G-7T"===i?g["9607T"]:"103-G-2A"===i?g["9602A"]:"103-G-6T"===i?g["9606T"]:g.normal,t&&0==$('.validateData input[name="water_imbibition"]').val()&&(o=0),u="",$('.validateData input[type="text"]:enabled').each(function(t,i){if(e=$(this).attr("name"),a=$(this).val(),void 0!==r[e]&&""!==a&&(a<r[e].min||a>r[e].max)){var s=$(".validateData input[name="+e+"]:enabled").parents(".form-group").find("label").text();"water_imbibition"==e||"sur_Strength"==e||"sur_oil_imbibition"==e||"PH_val"==e?o&&(n-=r[e].score,u+=s+"、"):(n-=r[e].score,u+=s+"、")}}),n}function p(){var t,e,a=1;"103-G-7T"===GetSelect2Text("Prod_id")?g["9607T"]:"103-G-2A"===GetSelect2Text("Prod_id")?g["9602A"]:g.normal;return $('.normalPara input[type="text"]:enabled').each(function(r,n){t=$(this).attr("name"),""!=(e=$(this).val().trim())&&"0"==d(t,e,!0)&&(a=0)}),a}var c,u,h,f=function(){jQuery().datepicker&&$(".date-picker").datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"yyyy-mm-dd"})};$('select[name="oper_id"]').change(function(){n()||s()}),$('select[name="machine_id"]').change(function(){n()||s(),r()}),$('select[name="Prod_id"]').change(function(){var t=getRootPath(1)+"/assets/pages/controller/data/paper_physic.json",e=GetSelect2Text("Prod_id");$('[name="delta_e_fb"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="chroma_L"]').attr("disabled",!1).parents(".form-group").show(),$('[name="chroma_a"]').attr("disabled",!1).parents(".form-group").show(),$('[name="chroma_b"]').attr("disabled",!1).parents(".form-group").show(),$('[name="tearing_hor"]').attr("disabled",!0).parents(".form-group").hide(),"103-G-7T"===e?($.get(t,function(t){o(t,"normal"),o(t,"9607T")}),$('[name*="crumpled_porosity"]').attr("disabled",!1).parents(".form-group").show(),$('[name="fibre_tz12"]').attr("disabled",!1).parents(".form-group").show(),$('[name="anti_crumpled_dry"]').attr("disabled",!1).parents(".form-group").show(),$('[name="avg_break_length"]').attr("disabled",!1).parents(".form-group").show(),$('[name="smoothness_front"]').attr("disabled",!1).parents(".form-group").show(),$('[name="smoothness_back"]').attr("disabled",!1).parents(".form-group").show(),$('[name="tensile_strength_wet"]').attr("disabled",!1).parents(".form-group").show()):"103-G-6T"===e||"103-G-4T"===e?($.get(t,function(t){o(t,"normal"),o(t,"103-G-6T"===e?"9606T":"9604T")}),$('[name="tearing_hor"]').attr("disabled",!1).parents(".form-group").show(),$('[name="chroma_L"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="chroma_a"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="chroma_b"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="delta_e_fb"]').attr("disabled",!1).parents(".form-group").show(),$('[name*="crumpled_porosity"]').attr("disabled",!1).parents(".form-group").show(),$('[name="fibre_tz12"]').attr("disabled",!1).parents(".form-group").show(),$('[name="anti_crumpled_dry"]').attr("disabled",!1).parents(".form-group").show(),$('[name="roughness_f"]').attr("disabled",!1).parents(".form-group").show(),$('[name="roughness_b"]').attr("disabled",!1).parents(".form-group").show(),$('[name="avg_break_length"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="smoothness_front"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="smoothness_back"]').attr("disabled",!0).parents(".form-group").hide(),$('[name="tensile_strength_wet"]').attr("disabled",!0).parents(".form-group").hide()):($('input[name="water_imbibition"]').parent().find("span").text("40~70 g/m^2"),$('input[name="basis_weight"]').parent().find("span").text("90±3%"),$('input[name="thickness"]').parent().find("span").text("102-113"),$('input[name="whiteness"]').parent().find("span").text("80-84"),$('input[name="crumpled_porosity_front"]').parent().find("span").text(""),$('input[name="crumpled_porosity_front"]').parent().find("span").text(""),$('[name*="crumpled_porosity"]').attr("disabled",!0).val(0).parents(".form-group").hide(),$('[name="fibre_tz12"]').attr("disabled",!0).val(0).parents(".form-group").hide(),"103-G-2A"===GetSelect2Text("Prod_id")?$('[name="anti_crumpled_dry"]').attr("disabled",!0).val(0).parents(".form-group").hide():$('[name="anti_crumpled_dry"]').attr("disabled",!1).parents(".form-group").show(),$('[name="roughness_f"]').attr("disabled",!0).val(0).parents(".form-group").hide(),$('[name="roughness_b"]').attr("disabled",!0).val(0).parents(".form-group").hide(),$('[name="smoothness_front"]').attr("disabled",!1).parents(".form-group").show(),$('[name="smoothness_back"]').attr("disabled",!1).parents(".form-group").show(),$('[name="tensile_strength_wet"]').attr("disabled",!1).parents(".form-group").show()),n()?$(".grey-cascade").html(""):s()}),$('input[name="Reel_Code"]').on("blur",function(t){$(this).val().length>1&&"-1"!==$('select[name="Prod_id"]').val()?i()&&($('.portlet button[type="submit"]').text("更新"),$(".amounts h4").html("<strong>评价总分:</strong> "+m())):"更新"==$('.portlet button[type="submit"]').text().trim()&&$(this).data("reelcode")!=$(this).val()&&$('.portlet button[type="submit"]').text("提交")});var g={};$('.validateData input[type="text"]:enabled').on("change",function(){var t=m();d($(this).attr("name"),$(this).val(),!0),$(".amounts h4").html("<strong>评价总分:</strong> "+t)}),$('.validateData input[type="text"]:enabled').on("keyup",function(){var t=m();$(".amounts h4").html("<strong>评价总分:</strong> "+t)}),$('input[name="Reel_Code"]').on("keyup",function(){var t=$(this),e=jsRight(t.val(),1);2==t.val().length?(7==e&&(e=8),SetSelect2Val("Prod_id",e)):3==t.val().length&&SetSelect2Val("machine_id",e)});var b=function(){function e(){var t=getRootPath()+"/DataInterface/insert",e=getFormData("theForm"),a=m();$(".amounts h4").html("<strong>评价总分:</strong> "+a),e.tbl=TBL.PHYSIC,e.class_id=GetRadioChecked("class_id"),e.score=a,e.utf2gbk=["remark"],e.record_Time=today(1),e.class_id=GetiCheckChecked("class_id"),e.isNormal=p(),e.sreel=h,e.isNormal?e.score<100&&(e.remark="扣分项:"+jsOnRight(u,1)):(e.remark="不合格项:"+jsOnRight(c,1),e.score<100&&(e.remark+="    扣分项:"+jsOnRight(u,1))),$.ajax({url:t,type:"POST",data:e,success:function(t){var e=$.parseJSON(t);bsTips(e.message,e.type),n(),$(".portlet.light").hide()},error:function(t){infoTips("保存数据失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(t))}})}function a(){var t=getRootPath()+"/DataInterface/update",e=getFormData("theForm");e.tbl=TBL.PHYSIC,e.class_id=GetRadioChecked("class_id"),e.score=m(0),e.utf2gbk=["remark"],e.record_Time=today(1),e.class_id=GetiCheckChecked("class_id"),e.id=$('.portlet button[type="submit"]').data("sn"),e.isNormal=p(),e.isNormal?e.score<100&&(e.remark="扣分项:"+jsOnRight(u,1)):(e.remark="不合格项:"+jsOnRight(c,1),e.score<100&&(e.remark+="    扣分项:"+jsOnRight(u,1))),bsTips(1==e.isNormal?"合格":"不合格",1==e.isNormal?1:0),$.ajax({url:t,type:"POST",data:e,success:function(t){var e=$.parseJSON(t);infoTips(e.message,e.type),n(),$(".portlet.light").hide(),$(".normalPara input").removeAttr("disabled"),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("更新","提交"))},error:function(t){infoTips("更新数据失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(t))}}),$(".normalPara input").removeAttr("disabled"),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("更新","提交"))}function n(){r(),$('form input[type="text"]').val(""),$(".amounts h4").html("<strong>评价总分:</strong> 100"),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("更新","提交")),$("#checkbox2").iCheck("check"),$("#checkbox").iCheck("uncheck"),$(".normalPara input").removeAttr("disabled"),SetSelect2Val("oper_id",-1),SetSelect2Val("Prod_id",-1),SetSelect2Val("machine_id",-1),$(".portlet.light").hide(),$("input[name='rec_date']").val(today(6)),t(),c="",u=""}var o=getValidateRule("theForm");if(o.Reel_Code={minlength:6,maxlength:8,number:!1,required:!0},o.rec_date.number=!1,h){for(var i in o)o[i].required=!1;["temperature","Reel_Code","humidity","oper_id","machine_id","Prod_id"].forEach(function(t){o[t].required=!0}),console.log(o)}$("form[name=theForm]").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:o,messages:{Reel_Code:{required:"轴号不能为空."}},highlight:function(t){$(t).closest(".form-group").addClass("has-error")},success:function(t){t.closest(".form-group").removeClass("has-error"),t.remove()},submitHandler:function(t){}}),$('button[type="submit"]').on("click",function(){$("form[name=theForm]").validate().form()?"提交"==$('.portlet button[type="submit"]').text().trim()?e():a():infoTips("请确保所有必要信息均正确输入")}),$('a[name="reset"]').on("click",function(){n()}),$("#checkbox2").on("ifChecked",function(){($(this).prop("checked")?1:0)?$(".normalPara input").removeAttr("disabled"):$(".normalPara input").attr("disabled","true")})};return{init:function(){$(".portlet.light").hide(),$(".normalParaEdit").hide(),f(),a(),r(),b(),l()}}}();jQuery(document).ready(function(){initDom(),iCheckBoxInit(),$("#checkbox2").iCheck("check"),PaperParam.init()}),jQuery(window).resize(function(){HeadFix()});