var PaperParam=function(){function t(){$('form input[type="text"]').eq(0).focus()}function e(){var t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=24&M=3&t=1&cache=14400";$.ajax({url:t}).done(function(t){var e=handleAjaxData(t);InitSelect("Prod_id",e)}),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=23&M=3&t=0&cache=14400",$.ajax({url:t}).done(function(t){var e=handleAjaxData(t);InitSelect("machine_id",e)}),t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=25&M=3&t=1&cache=14400",$.ajax({url:t}).done(function(t){t=handleAjaxData(t),InitSelect("oper_id",t)}),initSelect2()}function a(){e(),$("input[name='rec_date']").val(today(6)),$("input[name='Reel_Code']").maxlength({limitReachedClass:"label label-danger",threshold:3}),$(".page-header .dropdown-quick-sidebar-toggler").hide(),u=getUrlParam("sreel"),u=null==u?0:u,t(),p="",m=""}function n(){var t=(new Date).getHours();t>=0&&t<8?SetiCheckChecked("class_id",2):t>=8&&t<16?SetiCheckChecked("class_id",0):SetiCheckChecked("class_id",1)}function r(){return""===$('select[name="oper_id"]').val()||""===$('select[name="prod_ID"]').val()||""===$('select[name="machine_ID"]').val()?($(".portlet.light").hide(),1):($(".portlet.light").show(),0)}function i(){var t=$('select[name="Prod_id"]').val()+$('input[name="Reel_Code"]').val(),e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=33&M=0&r="+t,a=ReadData(e);return"0"==a.rows?0:($('input[name="Reel_Code"]').data("reelcode",t),a.header.map(function(t){var e=t.title;$('form .form-control[name="'+e+'"]').val(a.data[0][e])}),SetSelect2Val("oper_id",a.data[0].oper_id),SetSelect2Val("Prod_id",a.data[0].Prod_id),SetSelect2Val("machine_id",a.data[0].machine_id),SetiCheckChecked("class_id",a.data[0].class_id),$('.portlet button[type="submit"]').data("sn",a.data[0].ID),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("提交","更新")),$(".portlet.light").show(),o(),$(".amounts h4").html("<strong>评价总分:</strong> "+a.data[0].score),$("#checkbox2").iCheck("uncheck"),$(".normalPara input").attr("disabled","true"),$(".normalParaEdit").show(),1)}function o(){var t=$("input[name='rec_date']").val();t=t.substr(0,4)+t.substr(5,2);var e=$('select[name="Prod_id"]').val(),a=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=27&M=3&tmonth="+t+"&prod="+e,n=ReadData(a);a=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=28&M=3&tmonth="+t+"&prod="+e;var r=ReadData(a);$(".grey-cascade").html("物理指标："+xround(n.data[0][0],2)+"，外观指标："+xround(r.data[0][0],2)+"，总分："+xround(parseFloat(n.data[0][0])+parseFloat(r.data[0][0])-100,2))}function l(t,e,a){"undefined"==typeof a&&(a=!0);var n,r=1;if(n="103-G-7T"===GetSelect2Text("Prod_id")?f["9607T"]:"103-G-2A"===GetSelect2Text("Prod_id")?f["9602A"]:f.normal,"undefined"!=typeof n[t]){var i=$(".validateData input[name="+t+"]:enabled").parents(".form-group").find("label").text();e<n[t].w_min||e>n[t].w_max?(r=0,a&&(bsTips("【"+i+"】的值"+e+"不在指定范围内,产品判定为不合格，请仔细确认检查",0),p.indexOf(i)==-1&&(p+=i+"、"))):p=p.replace(i+"、","")}return r}function d(){var t=getRootPath(1)+"/assets/pages/controller/data/paper_physic.json";$.get(t,function(t){f=t})}function s(t){var e,a,n,r=100,i=1;return"undefined"==typeof t&&(t=0),n="103-G-7T"===GetSelect2Text("Prod_id")?f["9607T"]:"103-G-2A"===GetSelect2Text("Prod_id")?f["9602A"]:f.normal,t&&0==$('.validateData input[name="water_imbibition"]').val()&&(i=0),m="",$('.validateData input[type="text"]:enabled').each(function(t,o){if(e=$(this).attr("name"),a=$(this).val(),"undefined"!=typeof n[e]&&""!==a&&(a<n[e].min||a>n[e].max)){var l=$(".validateData input[name="+e+"]:enabled").parents(".form-group").find("label").text();"water_imbibition"==e||"sur_Strength"==e||"sur_oil_imbibition"==e||"PH_val"==e?i&&(r-=n[e].score,m+=l+"、"):(r-=n[e].score,m+=l+"、")}}),r}function c(){var t,e,a=1;"103-G-7T"===GetSelect2Text("Prod_id")?f["9607T"]:"103-G-2A"===GetSelect2Text("Prod_id")?f["9602A"]:f.normal;return $('.normalPara input[type="text"]:enabled').each(function(n,r){t=$(this).attr("name"),e=$(this).val().trim(),""!=e&&"0"==l(t,e,!0)&&(a=0)}),a}var p,m,u,h=function(){jQuery().datepicker&&$(".date-picker").datepicker({rtl:App.isRTL(),orientation:"left",autoclose:!0,format:"yyyy-mm-dd"})};$('select[name="oper_id"]').change(function(){r()||o()}),$('select[name="machine_id"]').change(function(){r()||o(),n()}),$('select[name="Prod_id"]').change(function(){return"103-G-7T"===GetSelect2Text("Prod_id")?($('input[name="water_imbibition"]').parent().find("span").text("20~40 g/m^2"),$('input[name="basis_weight"]').parent().find("span").text("95±3%"),$('input[name="thickness"]').parent().find("span").text("107-118"),$('input[name="whiteness"]').parent().find("span").text("81-85"),$('input[name="crumpled_porosity_front"]').parent().find("span").text("<=150"),$('input[name="crumpled_porosity_back"]').parent().find("span").text("<=150"),$('[name*="crumpled_porosity"]').attr("disabled",!1).parents(".form-group").show(),$('[name="fibre_tz12"]').attr("disabled",!1).parents(".form-group").show(),$('[name="anti_crumpled_dry"]').attr("disabled",!1).parents(".form-group").show()):($('input[name="water_imbibition"]').parent().find("span").text("40~70 g/m^2"),$('input[name="basis_weight"]').parent().find("span").text("90±3%"),$('input[name="thickness"]').parent().find("span").text("102-113"),$('input[name="whiteness"]').parent().find("span").text("80-84"),$('input[name="crumpled_porosity_front"]').parent().find("span").text(""),$('input[name="crumpled_porosity_front"]').parent().find("span").text(""),$('[name*="crumpled_porosity"]').attr("disabled",!0).val(0).parents(".form-group").hide(),$('[name="fibre_tz12"]').attr("disabled",!0).val(0).parents(".form-group").hide(),"103-G-2A"===GetSelect2Text("Prod_id")?$('[name="anti_crumpled_dry"]').attr("disabled",!0).val(0).parents(".form-group").hide():$('[name="anti_crumpled_dry"]').attr("disabled",!1).parents(".form-group").show()),r()?void $(".grey-cascade").html(""):void o()}),$('input[name="Reel_Code"]').on("blur",function(t){$(this).val().length>1&&"-1"!==$('select[name="Prod_id"]').val()?i()&&($('.portlet button[type="submit"]').text("更新"),$(".amounts h4").html("<strong>评价总分:</strong> "+s())):"更新"==$('.portlet button[type="submit"]').text().trim()&&$(this).data("reelcode")!=$(this).val()&&$('.portlet button[type="submit"]').text("提交")});var f={};$('.validateData input[type="text"]:enabled').on("change",function(){var t=s(),e=$(this).attr("name"),a=$(this).val();l(e,a,!0),$(".amounts h4").html("<strong>评价总分:</strong> "+t)}),$('.validateData input[type="text"]:enabled').on("keyup",function(){var t=s();$(".amounts h4").html("<strong>评价总分:</strong> "+t)}),$('input[name="Reel_Code"]').on("keyup",function(){var t=$(this),e=jsRight(t.val(),1);2==t.val().length?(7==e&&(e=8),SetSelect2Val("Prod_id",e)):3==t.val().length&&SetSelect2Val("machine_id",e)});var _=function(){function e(){var t=getRootPath()+"/DataInterface/insert",e=getFormData("theForm"),a=s();$(".amounts h4").html("<strong>评价总分:</strong> "+a),e.tbl=TBL.PHYSIC,e.class_id=GetRadioChecked("class_id"),e.score=a,e.utf2gbk=["remark"],e.record_Time=today(1),e.class_id=GetiCheckChecked("class_id"),e.isNormal=c(),e.sreel=u,e.isNormal?e.score<100&&(e.remark="扣分项:"+jsOnRight(m,1)):(e.remark="不合格项:"+jsOnRight(p,1),e.score<100&&(e.remark+="    扣分项:"+jsOnRight(m,1))),$.ajax({url:t,type:"POST",data:e,success:function(t){var e=$.parseJSON(t);bsTips(e.message,e.type),r(),$(".portlet.light").hide()},error:function(t){infoTips("保存数据失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(t))}})}function a(){var t=getRootPath()+"/DataInterface/update",e=getFormData("theForm");e.tbl=TBL.PHYSIC,e.class_id=GetRadioChecked("class_id"),e.score=s(0),e.utf2gbk=["remark"],e.record_Time=today(1),e.class_id=GetiCheckChecked("class_id"),e.id=$('.portlet button[type="submit"]').data("sn"),e.isNormal=c(),e.isNormal?e.score<100&&(e.remark="扣分项:"+jsOnRight(m,1)):(e.remark="不合格项:"+jsOnRight(p,1),e.score<100&&(e.remark+="    扣分项:"+jsOnRight(m,1))),bsTips(1==e.isNormal?"合格":"不合格",1==e.isNormal?1:0),$.ajax({url:t,type:"POST",data:e,success:function(t){var e=$.parseJSON(t);infoTips(e.message,e.type),r(),$(".portlet.light").hide(),$(".normalPara input").removeAttr("disabled"),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("更新","提交"))},error:function(t){infoTips("更新数据失败，请稍后重试或联系管理员!",0),infoTips(JSON.stringify(t))}}),$(".normalPara input").removeAttr("disabled"),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("更新","提交"))}function r(){n(),$('form input[type="text"]').val(""),$(".amounts h4").html("<strong>评价总分:</strong> 100"),$('.portlet button[type="submit"]').html($('.portlet button[type="submit"]').html().replace("更新","提交")),$("#checkbox2").iCheck("check"),$("#checkbox").iCheck("uncheck"),$(".normalPara input").removeAttr("disabled"),SetSelect2Val("oper_id",-1),SetSelect2Val("Prod_id",-1),SetSelect2Val("machine_id",-1),$(".portlet.light").hide(),$("input[name='rec_date']").val(today(6)),t(),p="",m=""}var i=getValidateRule("theForm");if(i.Reel_Code={minlength:6,maxlength:8,number:!1,required:!0},i.rec_date.number=!1,u){for(var o in i)i[o].required=!1;var l=["temperature","Reel_Code","humidity","oper_id","machine_id","Prod_id"];l.forEach(function(t){i[t].required=!0}),console.log(i)}$("form[name=theForm]").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!0,rules:i,messages:{Reel_Code:{required:"轴号不能为空."}},highlight:function(t){$(t).closest(".form-group").addClass("has-error")},success:function(t){t.closest(".form-group").removeClass("has-error"),t.remove()},submitHandler:function(t){}}),$('button[type="submit"]').on("click",function(){$("form[name=theForm]").validate().form()?"提交"==$('.portlet button[type="submit"]').text().trim()?e():a():infoTips("请确保所有必要信息均正确输入")}),$('a[name="reset"]').on("click",function(){r()}),$("#checkbox2").on("ifChecked",function(){var t=$(this).prop("checked")?1:0;t?$(".normalPara input").removeAttr("disabled"):$(".normalPara input").attr("disabled","true")})};return{init:function(){$(".portlet.light").hide(),$(".normalParaEdit").hide(),h(),a(),n(),_(),d()}}}();jQuery(document).ready(function(){initDom(),iCheckBoxInit(),$("#checkbox2").iCheck("check"),PaperParam.init()}),jQuery(window).resize(function(){HeadFix()});