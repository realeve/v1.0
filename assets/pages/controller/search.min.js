var ec=[],search=function(){function a(a,e){var t=parseInt(a,10)-parseInt(e,10);return 0>t&&(t+=1e4),t++,t}function e(){p.cart=$('[name="cart"]').val().trim().toUpperCase(),p.codeNo=$('[name="codeNo"]').val().trim(),p.paperNo=$('[name="paperNo"]').val().trim()}function t(a){p.type=judgeSearchType(p.cart),"undefined"==typeof a?p.updateHisInfo=!0:p.updateHisInfo=a;var e=!1;switch(p.type){case config.search.ERR:bsTips("请输入有效的车号或冠字信息"),e=!0;break;case config.search.GZ:""===p.prod?(bsTips("冠字号查询需选择品种信息"),e=!0):y(p);break;case config.search.CART:""!==p.codeNo&&4==p.codeNo.length?p.type=config.search.CODENO:""!==p.paperNo&&4==p.paperNo.length&&(p.type=config.search.PAPERNO),y(p);break;case config.search.CODE:}e&&$('[name="querySetting"]').click()}function r(){var a=today(1).replace(" ","T")+"+08",e='<div class="note note-danger margin-top-30"> <h4>该万产品未搜索到相关车号信息 <p class="margin-top-10">			<i class="fa fa-pencil"></i> <span>质量控制中心  发表于 <span name="isodate" title="'+a+'"></span> </span>		</p></h4></div>';$('[name="prodInfo"]').html(e),$("[name=isodate]").prettyDate({interval:1e4})}function n(){r(),$('[name="cartName"]').text(p.cart),$('[name="cartInfo"]').html(""),$("[name=qualityLine]").hide(),$('[name="hisCartList"]').hide(),$("[name=storageInfo]").hide(),$("#intaglio").html(""),$("#offset").html(""),$('[name="mahouInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),$('[name="mahouImg"]').html(""),ec[1].dispose(),$('[name="screenInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),$('[name="siyinImg"]').html("")}function i(a){"8"==a.substring(3,2)?($("#portlet_tab1").removeClass("hidden"),$('[href="#portlet_tab1"]').parent().removeClass("hidden")):$("#portlet_tab1").hasClass("hidden")||($("#portlet_tab1").addClass("hidden"),$('[href="#portlet_tab1"]').parent().addClass("hidden"))}function o(a,e){var t={start:"",end:""};return a.map(function(a){var r=jsLeft(a.ProcName,1);e==r&&(t.end=a.StartDate,""===t.start&&(t.start=a.StartDate))}),""!==t.start&&(t={start:t.start.split(" ")[0].replace(/-/g,""),end:t.end.split(" ")[0].replace(/-/g,"")}),t}function s(a){for(var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&blob=1&t="+a.cartID+"&ID="+(a.imgType?254:289),t=ReadData(e),r={data:[]},n=a.imgType?4:3,i=0;3>i;i++){var o=a.start+i*n;r.data.push({mac:a.data[o],pos:a.data[o+1],num:a.data[o+2],img:t.data[0][i],type:a.imgType?a.data[o+3]:"0"})}return r}function c(){p.cart=window.location.hash.replace("#",""),""!==p.cart&&t()}var d=function(a,e){function t(a){if(a=a.toUpperCase(),"A"==a)return"Z";var e=a.charCodeAt()-1;return String.fromCharCode(e)}function r(a,e){return e=e||4,a="000"+a,jsRight(a,e)}function n(a,e){var n={num:parseInt(a.replace(/[A-Za-z]/g,""),10),alpha:a.replace(/[0-9]/g,"").toUpperCase(),kNum:"9602A"==e||"9603A"==e?40:35},i={start:n.num-n.kNum,end:n.num},o={start:n.alpha[0],end:n.alpha[1]},s={start:n.alpha[0],end:n.alpha[1]};return i.start2=i.start,i.end2=i.end,i.start<0&&(i.start+=1e4,i.end=9999,i.start2=0,o.end=t(o.end),"A"==s.end&&(o.start=t(o.start))),{alpha:o,start:r(i.start),end:r(i.end),alpha2:s,start2:r(i.start2),end2:r(i.end2),codeNum:n.num}}function i(a,e){for(var t="",r=0;e>r;r++)t+="*";return a.start+t+a.end}for(var o=n(a,e),s=[/^[A-Za-z]{2}\d{4}$/,/^[A-Za-z]\d[A-Za-z]\d{3}$/,/^[A-Za-z]\d{2}[A-Za-z]\d{2}$/],c=0;3>c;c++)if(s[c].test(a)){o.alpha=i(o.alpha,c),o.alpha2=i(o.alpha2,c);break}return o},p={prod:"",cart:"",codeNo:"",paperNo:"",type:0},l={},h=function(a){tpl.render("search/prodinfo.etpl",a,$('[name="prodInfo"]')),tpl.render("search/cartinfo.etpl",a.data[0],$('[name="cartInfo"]'))},m=function(a){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=285&M=3&mid="+a+"&cache=1440",t=ReadData(e);t.showHead=1,tpl.render("simpleTable.etpl",t,$('[name="storageInfo"]'))},u=function(a){if("码后核查"!==a.TechTypeName)return $("[name=qualityLine]").hide(),void $('[name="hisCartList"]').hide();$("[name=qualityLine]").show(),$('[name="hisCartList"]').show();var e={xAxis:[],yAxis:[],type:"line"},t=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=282&M=3&cart="+a.CartNumber+"&cache=1440",r=ReadData(t);r.data.map(function(t){e.xAxis.push(t[1]),e.yAxis.push(t[2]),t[1]==a.CartNumber&&(a.MahouID=t[0],m(a.MahouID))}),ec[0]=echarts.init(document.getElementById("chart"));var n=getSimpleEChart(e);ec[0].setOption(n),tpl.render("search/hisCartList.etpl",r,$('[name="hisCartList"]'))},f=function(a){var e=a[0].CartNumber.trim(),t=e.substring(3,2);e=encodeURI("%")+jsRight(e,3)+encodeURI("%");var r=o(a,"胶"),n=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&M=3&cart="+e+"&prod="+t,i="&tstart="+r.start+"&tend="+r.end+"&ID=",s=ReadData(n+i+"287&cache=1440");tpl.render("simpleTable.etpl",s,$("#offset")),r=o(a,"凹"),i="&tstart="+r.start+"&tend="+r.end+"&ID=",s=ReadData(n+i+"286&cache=1440"),tpl.render("simpleTable.etpl",s,$("#intaglio"))},g=function(a){if(i(a),"8"===a.substring(3,2)){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=288&M=3&cart="+a,t=ReadData(e);if(0===t.rows)return $('[name="screenInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),void $('[name="siyinImg"]').html("");var r={title:t.title,rows:t.rows,cols:t.cols,source:t.source,header:t.header.slice(1,11),data:t.data[0].slice(1,11)};tpl.render("search/screenQuality.etpl",r,$('[name="screenInfo"]'));var n=s({data:t.data[0],start:11,imgType:0,cartID:t.data[0][0]});tpl.render("imglist.etpl",n,$('[name="siyinImg"]'))}},I=function(a){for(var e={xAxis:[],yAxis:[],type:"bar"},t=28;37>t;t++)e.xAxis.push(a.header[t].title),e.yAxis.push(a.data[0][t]);ec[1]=echarts.init(document.getElementById("mahouChart"));var r=getSimpleEChart(e,1);r.tooltip.formatter="{b}路:{c}条",delete r.yAxis.max,ec[1].setOption(r)},v=function(a){var e=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=290&M=3&cart="+a,t=ReadData(e);if(0===t.rows)return $('[name="mahouInfo"]').html("<h4> 该万产品未搜索到相关信息 </h4>"),$('[name="mahouImg"]').html(""),void ec[1].dispose();I(t);var r={title:t.title,rows:t.rows,cols:t.cols,source:t.source,header:t.header.slice(1,15),noScroll:1,data:[]};r.data.push(t.data[0].slice(1,15)),tpl.render("simpleTable.etpl",r,$('[name="mahouInfo"]'));var n=s({data:t.data[0],start:16,imgType:1,cartID:t.data[0][0]});tpl.render("imglist.etpl",n,$('[name="mahouImg"]'))},y=function(e){l={};var t,r,i=getRootPath(1)+"/DataInterface/Api?Token="+config.TOKEN+"&ID=";if(e.type==config.search.GZ){var o=d(e.cart,e.prod);if(t=i+284+"&M=0&prod="+e.prod+"&alpha="+o.alpha+"&start="+o.start+"&end="+o.end+"&alpha2="+o.alpha2+"&start2="+o.start2+"&end2="+o.end2,r=ReadData(t),$("[name=prodNum]").html(r.rows),!(r.rows>0))return void n();r.data[0].kInfo=a(o.codeNum,r.data[0].GzNumber)}else{if(t=i+283+"&M=0&cart="+e.cart+"&cache=1440",r=ReadData(t),$("[name=prodNum]").html(r.rows),!(r.rows>0))return void n();r.data[0].kInfo=0}l=r.data[0],l.imgUrl=getRootPath(1)+"/search/fakeImg/#"+l.CartNumber,$('[name="cartName"]').text(l.CartNumber),r.data.map(function(a,e){r.data[e].WeekDay=getWeekdayByDate(a.StartDate),r.data[e].DateTitle=a.StartDate.replace(" ","T")+"+08"}),h(r),e.type==config.search.CODENO||e.type==config.search.PAPERNO,f(r.data),g(l.CartNumber),v(l.CartNumber),p.updateHisInfo&&(u(l),bsTips("历史信息加载完毕"))},D=function(){$(".btn-theme-panel").removeClass("open"),e(),t()};return $(".theme-colors > li",".theme-panel").click(function(){p.prod=$(this).find("span").last().text(),$("ul > li",".theme-panel").removeClass("active"),$(this).addClass("active")}),$("#query").click(function(){D()}),$("body").on("click","[name=hiscart]",function(){var a=$(this);p.cart=a.attr("href").replace("#","");var e=!1;t(e)}),{init:function(){hideSidebarTool(),$(".theme-panel").first().remove(),$('[name="qualityLine"]').hide(),$('[name="hisCartList"]').hide();var a=["search/prodinfo.etpl","search/cartinfo.etpl","simpleTable.etpl","search/hisCartList.etpl","search/screenQuality.etpl","imglist.etpl"];tpl.init(a,c)}}}();jQuery(document).ready(function(){UIIdleTimeout.init(),initDashboardDaterange("YYYYMMDD"),initDom(),search.init(),bsTips("点击本页面工序名称将自动折叠面板")}),jQuery(window).resize(function(){ec[0].resize(),ec[1].resize()});